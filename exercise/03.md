# React

Testando um componente React

## Prática

Crie o arquivo `button.test.js`

```js
test.todo('renders a text')

test.todo('renders another text')
```

Como fazemos para [renderizar um componente React no DOM](https://react.dev/reference/react-dom/client/createRoot)?

Crie um elemento DOM

```js
test('renders a text', () => {
  const domNode = document.createElement('div')
  document.body.appendChild(domNode)
})
```

O teste deve dar esse erro:

```
Consider using the "jsdom" test environment.
    
ReferenceError: document is not defined
```

Execute o comando

```
npm i -D jest-environment-jsdom
```

No arquivo `jest.config.js` adicione:

```js
const config = {
  testEnvironment: 'jsdom',
}
```

Rode o teste novamente, ele não deve dar erro.

Para ver o HTML da div que criamos:

```js
console.log(document.body.outerHTML)
```

Importe a função `createRoot`

```diff
+ import { createRoot } from 'react-dom/client';
import { Button } from "./button"

test('renders a text', () => {
  const domNode = document.createElement('div')
+  const root = createRoot(domNode);
})
```

Depois faça o render do botão

```js
root.render(<Button />)
```

Como passamos um texto para o botão?

```js
root.render(<Button>Some Text</Button>)
```
Se olharmos o HTML da página, ainda não apareceu o botão.

```js
console.log(document.body.outerHTML)
```

Para que ele seja renderizado no ambiente de testes é necessário usar o `act`

```diff
import { createRoot } from 'react-dom/client';
+ import { act } from "react-dom/test-utils";
import { Button } from "./button"

+ global.IS_REACT_ACT_ENVIRONMENT = true;

test('renders a text', () => {
  const domNode = document.createElement('div')
  const root = createRoot(domNode);

+  act(() => root.render(<Button>Some Text</Button>))

  console.log(document.body.outerHTML)
})
```

Agora sim

```
console.log
  <body><div><button class="button button--block">Some Text</button></div></body>
```

Como verificamos se o botão tem o texto?

```js
const button = document.querySelector('button')
expect(button.textContent).toBe('Some Text')
```

Como testar o botão com outro texto?

```js
test('renders another text', () => {
  const domNode = document.createElement('div')
  document.body.appendChild(domNode)
  const root = createRoot(domNode);

  act(() => root.render(<Button>Another Text</Button>))

  const button = document.querySelector('button')
  expect(button.textContent).toBe('Another Text')
})
```

Deu erro

```
Expected: "Another Text"
Received: "Some Text"
```

Olha só porque:

```js
console.log(document.body.outerHTML)
```

Tem dois botões

```
<body><div><button class="button button--block">Some Text</button></div><div><button class="button button--block">Another Text</button></div></body>
```

Cleanup

```js
afterEach(() => {
  document.body.innerHTML = "";
});
```

Refatoração

```js
function render(Component) {
  const domNode = document.createElement('div')
  document.body.appendChild(domNode)
  const root = createRoot(domNode);
  act(() => root.render(Component))
}

afterEach(() => {
  document.body.innerHTML = "";
});

test('renders a text', () => {
  render(<Button>Some Text</Button>)
  const button = document.querySelector('button')
  expect(button.textContent).toBe('Some Text')
})

test('renders another text', () => {
  render(<Button>Another Text</Button>)
  const button = document.querySelector('button')
  expect(button.textContent).toBe('Another Text')
})
```

Instalando a React Testing Library

```
npm i -D @testing-library/react
```

Refatoração

```js
import { render } from '@testing-library/react';
import { Button } from "./button"

test('renders a text', () => {
  render(<Button>Some Text</Button>)
  const button = document.querySelector('button')
  expect(button.textContent).toBe('Some Text')
})

test('renders another text', () => {
  render(<Button>Another Text</Button>)
  const button = document.querySelector('button')
  expect(button.textContent).toBe('Another Text')
})
```

## Links

https://react.dev/reference/react-dom/client/createRoot
https://github.com/reactwg/react-18/discussions/102
https://testing-library.com/docs/react-testing-library/intro/
